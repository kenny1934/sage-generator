<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE: Secondary Academy Generator of Exercises ✨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- KaTeX CSS for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" xintegrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <!-- KaTeX JS for math rendering -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" xintegrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- Google APIs for Drive integration (optional) -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body {
            font-family: 'Inter', 'Georgia', serif;
            background: radial-gradient(ellipse at top left, #23272f 60%, #18181b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .main-container {
            background: rgba(44, 46, 56, 0.98);
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(60, 72, 88, 0.18);
            border: none;
            max-width: 44rem;
            width: 100%;
            margin-top: 3.5rem;
            padding: 3rem 2.2rem 2.5rem 2.2rem;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            display: block;
            border-radius: 50%;
            border: 2px solid #f87171;
            background: #23272f;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(60, 72, 88, 0.10);
        }
        .sage-title {
            color: #fff;
            font-family: 'Georgia', serif;
            font-size: 2.4rem;
            font-weight: 900;
            margin-bottom: 0.2rem;
            margin-top: 0.5rem;
            letter-spacing: 1.5px;
            text-align: center;
            line-height: 1.1;
        }
        .divider {
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
            border-radius: 2px;
            margin: 0.5rem auto 1.2rem auto;
        }
        .full-name {
            color: #f87171;
            font-family: 'Georgia', serif;
            font-size: 1.1rem;
            margin-bottom: 1.7rem;
            font-weight: normal;
            text-align: center;
            letter-spacing: 0.5px;
        }
        .full-name .em {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.15em;
            font-family: 'Georgia', serif;
            margin-right: 2px;
        }
        .subtitle-edu {
            color: #e5e7eb;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 2.2rem;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        label {
            color: #e5e7eb;
            font-weight: 500;
            font-size: 1.08rem;
        }
        input[type="text"], input[type="password"], textarea, select {
            background: #23272f;
            border: 1px solid #f87171;
            padding: 0.85rem 1.1rem;
            border-radius: 0.85rem;
            width: 100%;
            color: #e5e7eb;
            margin-bottom: 0.7rem;
            font-size: 1.08rem;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #ef4444;
            outline: none;
        }
        .action-btn {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
            color: #fff;
            padding: 0.7rem 1.5rem;
            border-radius: 0.7rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(60, 72, 88, 0.10);
        }
        .action-btn:hover {
            background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .action-btn:focus {
            outline: 2px solid #f87171;
            outline-offset: 2px;
        }
        .api-key-container {
            background: #23272f;
            border: 1px solid #f87171;
            padding: 0.7rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.2rem;
            font-size: 0.98rem;
            opacity: 0.85;
        }
        .question-item {
            background: #23272f;
            border-radius: 1rem;
            border: 1px solid #f87171;
            padding: 1.15rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(60, 72, 88, 0.06);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        .answer-content {
            background: #23272f;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }
        .latex-view {
            font-family: 'Courier New', monospace;
            background: #18181b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.95rem;
            color: #e5e7eb;
            display: none;
            overflow-x: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .math-rendered {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
            line-height: 1.6;
        }
        
        .math-rendered .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .math-rendered .katex {
            font-size: 1em;
        }
        .footer {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #ef4444;
            color: #f87171;
            background: none;
        }
        .footer p {
            font-size: 0.95rem;
        }
        
        /* Enhanced loading animations */
        .math-spinner {
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .math-symbol {
            font-size: 2rem;
            color: #f87171;
            animation: mathFloat 2s ease-in-out infinite;
            opacity: 0.7;
        }
        
        .math-symbol:nth-child(1) { animation-delay: 0s; }
        .math-symbol:nth-child(2) { animation-delay: 0.3s; }
        .math-symbol:nth-child(3) { animation-delay: 0.6s; }
        .math-symbol:nth-child(4) { animation-delay: 0.9s; }
        
        @keyframes mathFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            25% { transform: translateY(-10px) rotate(5deg); opacity: 1; }
            50% { transform: translateY(-15px) rotate(-5deg); opacity: 0.9; }
            75% { transform: translateY(-5px) rotate(3deg); opacity: 1; }
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(248, 113, 113, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
            background-size: 200% 100%;
            animation: progressSlide 2s linear infinite;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @keyframes progressSlide {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-message {
            color: #e5e7eb;
            font-size: 1rem;
            text-align: center;
            margin-top: 0.5rem;
            min-height: 1.5rem;
        }
        
        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            .main-container {
                padding: 1.5rem;
                margin-top: 2rem;
                margin-bottom: 2rem;
                border-radius: 1.5rem;
            }
            
            .sage-title {
                font-size: 2rem;
            }
            
            .full-name {
                font-size: 1rem;
                margin-bottom: 1.5rem;
            }
            
            /* Improve touch targets */
            .action-btn {
                min-height: 48px;
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
                touch-action: manipulation;
            }
            
            input[type="text"], input[type="password"], textarea, select {
                min-height: 48px;
                padding: 1rem 1.25rem;
                font-size: 1rem;
                touch-action: manipulation;
            }
            
            /* Better spacing for mobile */
            .space-y-8 > * + * {
                margin-top: 1.5rem;
            }
            
            /* Optimize button layout on mobile */
            .flex.gap-2.flex-wrap {
                gap: 0.75rem;
            }
            
            .flex.gap-2.flex-wrap .action-btn {
                flex: 1;
                min-width: 140px;
            }
            
            /* Improve question cards on mobile */
            .question-item {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .question-item .math-rendered {
                font-size: 1rem;
                line-height: 1.5;
            }
            
            /* Mobile-specific math symbol sizing */
            .math-symbol {
                font-size: 1.5rem;
            }
            
            /* Better progress bar visibility */
            .progress-bar {
                height: 6px;
                margin: 1.25rem 0;
            }
            
            /* Optimize keyboard shortcuts overlay for mobile */
            .fixed.inset-0 .bg-gray-800 {
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        @media (max-width: 640px) {
            .main-container {
                padding: 1.25rem;
                margin: 1rem;
                border-radius: 1rem;
            }
            
            .sage-title {
                font-size: 1.8rem;
            }
            
            .full-name {
                font-size: 0.95rem;
            }
            
            /* Stack buttons vertically on small screens */
            .flex.flex-col.sm\\:flex-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .flex.flex-col.sm\\:flex-row .action-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* Smaller math symbols for very small screens */
            .math-symbol {
                font-size: 1.25rem;
                gap: 0.25rem;
            }
            
            /* Compact question cards */
            .question-item {
                padding: 0.875rem;
            }
            
            .question-item h3 {
                font-size: 1.125rem;
            }
            
            .question-item .math-rendered {
                font-size: 0.9rem;
                line-height: 1.4;
            }
        }
        
        /* Touch-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects on touch devices */
            .action-btn:hover {
                transform: none;
                background: inherit;
            }
            
            /* Add press feedback instead */
            .action-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            
            /* Improve touch scroll */
            .main-container {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Better touch targets for copy buttons */
            .action-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Autocomplete and example topics styling */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #23272f;
            border: 1px solid #f87171;
            border-top: none;
            border-radius: 0 0 0.85rem 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-item {
            padding: 0.75rem 1.1rem;
            cursor: pointer;
            color: #e5e7eb;
            border-bottom: 1px solid rgba(248, 113, 113, 0.2);
            transition: background-color 0.2s;
        }
        
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: rgba(248, 113, 113, 0.1);
            color: #f87171;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .example-topics {
            margin-bottom: 1rem;
        }
        
        .example-topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .example-topic {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #e5e7eb;
            transition: all 0.2s;
            text-align: center;
        }
        
        .example-topic:hover {
            background: rgba(248, 113, 113, 0.2);
            border-color: #f87171;
            color: #f87171;
            transform: translateY(-1px);
        }
        
        .difficulty-description {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        /* Question navigation */
        .question-navigator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 0.75rem;
        }
        
        .nav-button {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid #f87171;
            color: #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            min-width: 80px;
        }
        
        .nav-button:hover:not(:disabled) {
            background: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .question-counter {
            color: #f87171;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .question-item {
            display: none;
        }
        
        .question-item.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <main id="main-content">
            <img src="./images/msa-logo.png" alt="MSA Logo" class="logo" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ffffff/dc2626?text=Logo';">
            <h1 class="sage-title">SAGE</h1>
            <div class="divider"></div>
            <div class="full-name">
                <span class="em">S</span>econdary <span class="em">A</span>cademy <span class="em">G</span>enerator of <span class="em">E</span>xercises
            </div>

            <!-- AI Disclaimer -->
            <div class="mb-6 p-3 bg-yellow-900/20 border border-yellow-600/30 rounded-lg text-yellow-200 text-sm text-center">
                <span class="font-semibold">⚠️ Educational Tool Notice:</span> This AI-powered generator creates practice problems for learning purposes. Always verify answers independently and consult your teacher or textbook for accuracy.
            </div>
            
            <!-- Google Drive Setup (hidden by default) -->
            <div id="googleDriveSetupPanel" class="mb-6 p-4 bg-blue-900/20 border border-blue-600/30 rounded-lg hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-blue-200">
                        ☁️ Google Drive Setup
                    </h3>
                    <button type="button" class="text-blue-400 hover:text-blue-300 text-sm" onclick="hideGoogleDriveSetup()">Close</button>
                </div>
                <div class="text-sm text-blue-200 mb-4">
                    <p class="mb-2">Enable multi-device sync for your Google Workspace:</p>
                    <ol class="list-decimal list-inside space-y-1 text-blue-300 text-xs">
                        <li>Go to <a href="https://console.cloud.google.com" target="_blank" class="text-blue-400 underline">Google Cloud Console</a></li>
                        <li>Enable the Google Drive API</li>
                        <li>Create OAuth 2.0 Client ID (Web application)</li>
                        <li>Add <code class="bg-gray-700 px-1 rounded text-blue-200" id="currentOriginDisplay">your current URL</code> to "Authorized JavaScript origins"</li>
                        <li>Enter Client ID below</li>
                    </ol>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label for="googleClientId" class="block text-sm font-medium text-blue-200 mb-1">Google OAuth Client ID:</label>
                        <input type="text" id="googleClientId" class="w-full p-2 text-sm bg-gray-800 border border-blue-500 rounded" placeholder="123456789-abcdefg.apps.googleusercontent.com">
                    </div>
                    <button type="button" class="action-btn bg-blue-600 hover:bg-blue-700 text-sm" onclick="saveGoogleDriveConfig()">
                        Save Configuration
                    </button>
                </div>
            </div>

            <!-- API Key Configuration -->
            <div id="apiKeyContainer" class="api-key-container">
                <label for="apiKeyInput" class="block text-sm font-semibold text-gray-200 mb-2">
                    Gemini API Key (required):
                </label>
                <div class="flex gap-2">
                    <input type="password" id="apiKeyInput" class="flex-1" placeholder="Enter your Gemini API key" aria-label="Gemini API Key">
                    <button id="saveApiKeyBtn" class="action-btn bg-red-600 hover:bg-red-700" aria-label="Save API Key">
                        Save
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-1">
                    Your API key is stored locally and never sent to our servers.
                </p>
            </div>
            

            <div class="space-y-8">
                <!-- Example Topics -->
                <div class="example-topics">
                    <label class="block text-lg font-semibold mb-2">
                        Popular Topics <span class="text-gray-400 text-sm">(click to select)</span>:
                    </label>
                    <div class="example-topics-grid" id="exampleTopicsGrid">
                        <!-- Example topics will be populated here -->
                    </div>
                </div>

                <div>
                    <label for="mathTopic" class="block text-lg font-semibold mb-2">
                        Maths Topic & Grade Level <span class="text-gray-400 text-sm">(e.g., "Algebra for Grade 7", "Trigonometry for Form 3")</span>:
                    </label>
                    <div class="autocomplete-container">
                        <textarea id="mathTopic" rows="3" class="w-full p-3 shadow-sm" placeholder="e.g., 'Solving linear equations in one unknown for F1', 'Complex number problems for Form 4'" aria-label="Maths Topic and Grade Level"></textarea>
                        <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>

                <div>
                    <label for="difficulty" class="block text-lg font-semibold mb-2">
                        Difficulty Level:
                    </label>
                    <select id="difficulty" class="w-full p-3 shadow-sm" aria-label="Difficulty Level">
                        <option value="Easy">Easy</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Hard">Hard</option>
                        <option value="Challenging">Challenging</option>
                    </select>
                    <div id="difficultyDescription" class="difficulty-description">
                        Medium complexity with step-by-step explanations
                    </div>
                </div>

                <button id="generateQuestionsBtn" class="w-full bg-red-600 text-white font-extrabold py-4 px-6 rounded-xl hover:bg-red-700 transition-all duration-300 ease-in-out shadow-lg transform hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-400 flex items-center justify-center text-xl" aria-label="Generate Math Questions">
                    Generate Maths Questions! ➕
                </button>

                <div id="loadingIndicator" class="hidden text-center mt-6" role="status" aria-live="polite">
                    <div class="math-spinner justify-center">
                        <span class="math-symbol">π</span>
                        <span class="math-symbol">∑</span>
                        <span class="math-symbol">∫</span>
                        <span class="math-symbol">∞</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="loadingMessage" class="loading-message">Initializing math generator...</div>
                </div>

                <div id="questionsContainer" class="hidden mt-10 border-t-2 border-gray-700 pt-10">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <h2 class="text-3xl font-bold text-white text-center sm:text-left flex-grow">Your Generated Questions</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button id="exportQuestionsBtn" class="action-btn bg-red-500 hover:bg-red-600 text-sm sm:text-base" aria-label="Export questions to text file">
                                Export Questions
                            </button>
                            <button id="showFavoritesBtn" class="action-btn bg-yellow-600 hover:bg-yellow-700 text-sm sm:text-base" aria-label="View your favorite questions" onclick="showFavoritesPanel()">
                                ⭐ Favorites
                            </button>
                            <button id="toggleMathViewBtn" class="action-btn bg-gray-500 hover:bg-gray-600 text-sm sm:text-base" aria-label="Toggle between rendered math and raw LaTeX view">
                                Toggle Maths View (Rendered)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Question Navigator -->
                    <div id="questionNavigator" class="question-navigator hidden">
                        <button id="prevQuestionBtn" class="nav-button" aria-label="Previous question">
                            ← Previous
                        </button>
                        <div class="question-counter" id="questionCounter">
                            Question 1 of 3
                        </div>
                        <button id="nextQuestionBtn" class="nav-button" aria-label="Next question">
                            Next →
                        </button>
                    </div>
                    
                    <div id="mathQuestionsList" class="space-y-8" role="list">
                        <!-- Math questions will be inserted here -->
                    </div>
                    <button id="resetBtn" class="hidden w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-all duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-400 mt-8" aria-label="Generate New Questions">
                        Generate New Questions
                    </button>
                </div>

                <div id="messageContainer" class="mt-8" role="alert" aria-live="polite">
                    <p class="text-gray-400 text-center" id="initialMessage">Your generated maths questions will appear here.</p>
                </div>
            </div>
        </main>
        <footer class="footer">
            <p>&copy; 2025 MathConcept Secondary Academy. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // NOTE: Javascript logic remains the same, only styling was updated.
        // Configuration constants
        const CONFIG = {
            API_BASE_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite-preview-06-17:generateContent',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            STORAGE_KEY: 'sage_api_key',
            MESSAGE_TIMEOUT: 3000,
            // New storage keys for Phase 3 features
            PREFERENCES_KEY: 'sage_preferences',
            HISTORY_KEY: 'sage_history',
            FAVORITES_KEY: 'sage_favorites',
            STATS_KEY: 'sage_stats'
        };

        // Get references to DOM elements
        const mathTopicInput = document.getElementById('mathTopic');
        const difficultySelect = document.getElementById('difficulty');
        const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const questionsContainer = document.getElementById('questionsContainer');
        const mathQuestionsList = document.getElementById('mathQuestionsList');
        const resetBtn = document.getElementById('resetBtn');
        const messageContainer = document.getElementById('messageContainer');
        const initialMessage = document.getElementById('initialMessage');
        const toggleMathViewBtn = document.getElementById('toggleMathViewBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyContainer = document.getElementById('apiKeyContainer');
        const exportQuestionsBtn = document.getElementById('exportQuestionsBtn');

        let isMathRendered = true; // Default state: math is rendered
        let isKaTeXLoaded = false;
        let currentQuestions = []; // Store current questions for export
        let mathRenderCache = new Map(); // Cache for rendered math content
        let isOnline = navigator.onLine;
        let networkStatusIndicator;
        let currentQuestionIndex = 0;
        let totalQuestions = 0;
        
        // Google Drive integration (optional enhancement)
        let googleDriveAvailable = false;
        let isGoogleSignedIn = false;

        // Phase 3: Data Management and Personalization
        class DataManager {
            static loadPreferences() {
                try {
                    const preferences = localStorage.getItem(CONFIG.PREFERENCES_KEY);
                    return preferences ? JSON.parse(preferences) : {
                        preferredDifficulty: 'Medium',
                        preferredTopics: [],
                        lastUsedTopic: '',
                        autoSaveHistory: true,
                        maxHistoryItems: 50
                    };
                } catch (error) {
                    console.error('Error loading preferences:', error);
                    return this.getDefaultPreferences();
                }
            }

            static savePreferences(preferences) {
                try {
                    localStorage.setItem(CONFIG.PREFERENCES_KEY, JSON.stringify(preferences));
                } catch (error) {
                    console.error('Error saving preferences:', error);
                }
            }

            static getDefaultPreferences() {
                return {
                    preferredDifficulty: 'Medium',
                    preferredTopics: [],
                    lastUsedTopic: '',
                    autoSaveHistory: true,
                    maxHistoryItems: 50
                };
            }

            static loadHistory() {
                try {
                    const history = localStorage.getItem(CONFIG.HISTORY_KEY);
                    return history ? JSON.parse(history) : [];
                } catch (error) {
                    console.error('Error loading history:', error);
                    return [];
                }
            }

            static saveHistory(historyItems) {
                try {
                    const preferences = this.loadPreferences();
                    if (!preferences.autoSaveHistory) return;

                    // Limit history size
                    const limitedHistory = historyItems.slice(0, preferences.maxHistoryItems);
                    localStorage.setItem(CONFIG.HISTORY_KEY, JSON.stringify(limitedHistory));
                } catch (error) {
                    console.error('Error saving history:', error);
                }
            }

            static addToHistory(topic, difficulty, questionsCount = 3) {
                const history = this.loadHistory();
                const historyItem = {
                    id: Date.now(),
                    topic: topic.trim(),
                    difficulty,
                    questionsCount,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString()
                };

                // Remove duplicate topics (keep most recent)
                const filteredHistory = history.filter(item => 
                    item.topic.toLowerCase() !== topic.toLowerCase().trim()
                );

                // Add new item at the beginning
                const updatedHistory = [historyItem, ...filteredHistory];
                this.saveHistory(updatedHistory);
                this.updateStats(topic, difficulty);

                return updatedHistory;
            }

            static getRecentTopics(limit = 6) {
                const history = this.loadHistory();
                return history.slice(0, limit).map(item => ({
                    topic: item.topic,
                    difficulty: item.difficulty,
                    lastUsed: item.date
                }));
            }

            static loadStats() {
                try {
                    const stats = localStorage.getItem(CONFIG.STATS_KEY);
                    return stats ? JSON.parse(stats) : {
                        totalQuestions: 0,
                        totalSessions: 0,
                        favoriteTopics: {},
                        difficultyDistribution: {},
                        firstUsed: new Date().toISOString(),
                        lastUsed: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('Error loading stats:', error);
                    return this.getDefaultStats();
                }
            }

            static saveStats(stats) {
                try {
                    localStorage.setItem(CONFIG.STATS_KEY, JSON.stringify(stats));
                } catch (error) {
                    console.error('Error saving stats:', error);
                }
            }

            static updateStats(topic, difficulty) {
                const stats = this.loadStats();
                
                stats.totalQuestions += 3; // Assuming 3 questions per generation
                stats.totalSessions += 1;
                stats.lastUsed = new Date().toISOString();

                // Track favorite topics
                const topicKey = topic.toLowerCase().trim();
                stats.favoriteTopics[topicKey] = (stats.favoriteTopics[topicKey] || 0) + 1;

                // Track difficulty distribution
                stats.difficultyDistribution[difficulty] = (stats.difficultyDistribution[difficulty] || 0) + 1;

                this.saveStats(stats);
            }

            static getDefaultStats() {
                return {
                    totalQuestions: 0,
                    totalSessions: 0,
                    favoriteTopics: {},
                    difficultyDistribution: {},
                    firstUsed: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                };
            }

            static loadFavorites() {
                try {
                    const favorites = localStorage.getItem(CONFIG.FAVORITES_KEY);
                    return favorites ? JSON.parse(favorites) : [];
                } catch (error) {
                    console.error('Error loading favorites:', error);
                    return [];
                }
            }

            static saveFavorites(favorites) {
                try {
                    localStorage.setItem(CONFIG.FAVORITES_KEY, JSON.stringify(favorites));
                } catch (error) {
                    console.error('Error saving favorites:', error);
                }
            }

            static addToFavorites(question, answer, solution, topic, difficulty) {
                const favorites = this.loadFavorites();
                const favorite = {
                    id: Date.now(),
                    question,
                    answer,
                    solution,
                    topic,
                    difficulty,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString()
                };

                favorites.unshift(favorite);
                this.saveFavorites(favorites);
                return favorites;
            }

            static removeFromFavorites(favoriteId) {
                const favorites = this.loadFavorites();
                const updatedFavorites = favorites.filter(fav => fav.id !== favoriteId);
                this.saveFavorites(updatedFavorites);
                return updatedFavorites;
            }
        }

        // Initialize the application
        function initializeApp() {
            // Load saved API key
            const savedApiKey = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiKeyContainer.style.display = 'none';
            }

            // Phase 3: Load user preferences and apply them
            loadAndApplyUserPreferences();
            
            // Phase 3: Initialize personalization features
            initializePersonalizationFeatures();

            // Check if KaTeX is loaded
            checkKaTeXLoaded();
            
            // Initialize mobile enhancements
            initializeMobileFeatures();
            
            // Initialize network monitoring
            initializeNetworkMonitoring();
            
            // Initialize smart input features
            initializeSmartInput();
            
            // Check for Google Drive availability (optional)
            checkGoogleDriveAvailability();
        }
        
        // Check if Google Drive APIs are available (non-blocking)
        function checkGoogleDriveAvailability() {
            const statusElement = document.getElementById('googleDriveStatus');
            if (statusElement) statusElement.textContent = 'Checking...';
            
            // Wait a moment for scripts to load
            setTimeout(() => {
                if (typeof window.gapi !== 'undefined' && typeof window.google !== 'undefined') {
                    googleDriveAvailable = true;
                    console.log('Google Drive APIs detected - multi-device sync available');
                    
                    if (statusElement) {
                        statusElement.textContent = 'Available (setup required)';
                        statusElement.className = 'text-blue-400';
                    }
                    
                    // Show setup button
                    const setupBtn = document.getElementById('googleDriveSetupBtn');
                    if (setupBtn) setupBtn.classList.remove('hidden');
                    
                    // Check if already configured
                    const savedClientId = localStorage.getItem('google_client_id');
                    if (savedClientId) {
                        if (statusElement) {
                            statusElement.textContent = 'Configured (ready to connect)';
                            statusElement.className = 'text-green-400';
                        }
                        
                        // Try to initialize Google Drive
                        initializeGoogleDrive(savedClientId);
                    }
                } else {
                    console.log('Google Drive APIs not available - using localStorage only');
                    
                    if (statusElement) {
                        statusElement.textContent = 'Not available';
                        statusElement.className = 'text-gray-500';
                    }
                }
            }, 3000);
        }
        
        function showGoogleDriveSetup() {
            const panel = document.getElementById('googleDriveSetupPanel');
            if (panel) {
                panel.classList.remove('hidden');
                
                // Load saved client ID if exists
                const savedClientId = localStorage.getItem('google_client_id');
                if (savedClientId) {
                    document.getElementById('googleClientId').value = savedClientId;
                }
                
                // Show current origin for easy copying
                const originDisplay = document.getElementById('currentOriginDisplay');
                if (originDisplay) {
                    originDisplay.textContent = window.location.origin;
                }
            }
        }
        
        function hideGoogleDriveSetup() {
            const panel = document.getElementById('googleDriveSetupPanel');
            if (panel) panel.classList.add('hidden');
        }
        
        function saveGoogleDriveConfig() {
            const clientId = document.getElementById('googleClientId').value.trim();
            
            if (!clientId) {
                displayMessage('Please enter the Google Client ID', 'text-red-500');
                return;
            }
            
            if (!clientId.includes('.googleusercontent.com')) {
                displayMessage('Please enter a valid Google Client ID', 'text-red-500');
                return;
            }
            
            // Save the client ID
            localStorage.setItem('google_client_id', clientId);
            
            // Update UI
            const statusElement = document.getElementById('googleDriveStatus');
            if (statusElement) {
                statusElement.textContent = 'Configured (ready to connect)';
                statusElement.className = 'text-green-400';
            }
            
            hideGoogleDriveSetup();
            displayMessage('Google Drive configured successfully!', 'text-green-400');
            
            // Try to initialize with the new client ID
            initializeGoogleDrive(clientId);
        }
        
        // Initialize Google Drive with client ID
        async function initializeGoogleDrive(clientId) {
            if (!googleDriveAvailable) return;
            
            try {
                console.log('Initializing Google Drive...');
                
                // Check if running from file:// protocol
                const isLocalFile = window.location.protocol === 'file:';
                if (isLocalFile) {
                    console.warn('Google Drive requires HTTPS or localhost. Try running: python -m http.server 8000');
                    
                    const statusElement = document.getElementById('googleDriveStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Setup error';
                        statusElement.className = 'text-red-400';
                    }
                    
                    displayMessage('Google Drive requires HTTPS or localhost. Try running: python -m http.server 8000', 'text-yellow-400');
                    return;
                }
                
                // Initialize gapi client
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('Timeout')), 10000);
                    
                    window.gapi.load('client:auth2', {
                        callback: () => {
                            clearTimeout(timeout);
                            resolve();
                        },
                        onerror: (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        }
                    });
                });
                
                // Initialize client with cookiePolicy for local testing
                const initConfig = {
                    clientId: clientId,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/drive.file'
                };
                
                if (isLocalFile) {
                    initConfig.cookiePolicy = 'single_host_origin';
                }
                
                await window.gapi.client.init(initConfig);
                
                console.log('Google Drive initialized successfully');
                
                // Update status and add connect button
                const statusElement = document.getElementById('googleDriveStatus');
                if (statusElement) {
                    statusElement.textContent = 'Ready to connect';
                    statusElement.className = 'text-green-400';
                }
                
                addGoogleDriveConnectButton();
                
            } catch (error) {
                console.error('Failed to initialize Google Drive:', error);
                console.error('Error details:', error.message || error.details);
                
                const statusElement = document.getElementById('googleDriveStatus');
                if (statusElement) {
                    statusElement.textContent = 'Setup error';
                    statusElement.className = 'text-red-400';
                }
                
                let errorMsg = 'Failed to initialize Google Drive. Please check your credentials.';
                
                // Handle different error types
                if (error.message && error.message.includes('Invalid cookiePolicy')) {
                    errorMsg = 'Google Drive requires HTTPS or localhost. Try running: python -m http.server 8000';
                } else if (error.error === 'idpiframe_initialization_failed' || 
                          (error.details && error.details.includes('Not a valid origin'))) {
                    const currentOrigin = window.location.origin;
                    errorMsg = `OAuth error: ${currentOrigin} is not authorized. Add this URL to your Google Cloud Console OAuth settings under "Authorized JavaScript origins".`;
                } else if (error.message) {
                    errorMsg = `Google Drive error: ${error.message}`;
                } else if (error.details) {
                    errorMsg = `Google Drive error: ${error.details}`;
                }
                
                displayMessage(errorMsg, 'text-red-500');
            }
        }
        
        function addGoogleDriveConnectButton() {
            const setupBtn = document.getElementById('googleDriveSetupBtn');
            if (setupBtn && !document.getElementById('googleDriveConnectBtn')) {
                const connectBtn = document.createElement('button');
                connectBtn.id = 'googleDriveConnectBtn';
                connectBtn.className = 'text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors ml-2';
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = connectToGoogleDrive;
                
                setupBtn.parentNode.appendChild(connectBtn);
            }
        }
        
        // Connect to Google Drive
        async function connectToGoogleDrive() {
            try {
                const authInstance = window.gapi.auth2.getAuthInstance();
                googleUser = await authInstance.signIn();
                isGoogleSignedIn = true;
                
                console.log('Signed in to Google Drive successfully');
                
                // Update UI
                const statusElement = document.getElementById('googleDriveStatus');
                if (statusElement) {
                    const profile = googleUser.getBasicProfile();
                    statusElement.textContent = `Connected as ${profile.getName()}`;
                    statusElement.className = 'text-green-400';
                }
                
                // Hide connect button, show disconnect
                const connectBtn = document.getElementById('googleDriveConnectBtn');
                if (connectBtn) {
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.className = 'text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded transition-colors ml-2';
                    connectBtn.onclick = disconnectFromGoogleDrive;
                }
                
                displayMessage('Connected to Google Drive successfully!', 'text-green-400');
                
            } catch (error) {
                console.error('Failed to connect to Google Drive:', error);
                displayMessage('Failed to connect to Google Drive', 'text-red-500');
            }
        }
        
        async function disconnectFromGoogleDrive() {
            try {
                const authInstance = window.gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                
                isGoogleSignedIn = false;
                googleUser = null;
                
                // Update UI
                const statusElement = document.getElementById('googleDriveStatus');
                if (statusElement) {
                    statusElement.textContent = 'Ready to connect';
                    statusElement.className = 'text-green-400';
                }
                
                // Restore connect button
                const connectBtn = document.getElementById('googleDriveConnectBtn');
                if (connectBtn) {
                    connectBtn.textContent = 'Connect';
                    connectBtn.className = 'text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors ml-2';
                    connectBtn.onclick = connectToGoogleDrive;
                }
                
                displayMessage('Disconnected from Google Drive', 'text-gray-400');
                
            } catch (error) {
                console.error('Failed to disconnect from Google Drive:', error);
            }
        }

        // Phase 3: Load and apply user preferences
        function loadAndApplyUserPreferences() {
            const preferences = DataManager.loadPreferences();
            
            // Apply preferred difficulty
            difficultySelect.value = preferences.preferredDifficulty;
            
            // Set last used topic if available
            if (preferences.lastUsedTopic) {
                mathTopicInput.value = preferences.lastUsedTopic;
            }
        }

        // Phase 3: Initialize personalization features
        function initializePersonalizationFeatures() {
            // Add recently used topics section
            addRecentTopicsSection();
            
            // Add topic recommendations
            addTopicRecommendationsSection();
            
            // Add stats dashboard
            addStatsDashboard();
            
            // Update stats display
            updateStatsDisplay();
        }

        // Phase 3: Add recently used topics section
        function addRecentTopicsSection() {
            const recentTopics = DataManager.getRecentTopics(6);
            
            if (recentTopics.length === 0) return;
            
            const container = document.querySelector('.main-container');
            const topicInput = document.getElementById('mathTopic').parentElement;
            
            const recentSection = document.createElement('div');
            recentSection.className = 'mb-6';
            recentSection.innerHTML = `
                <label class="block mb-3 text-sm font-medium text-gray-300">
                    📚 Recently Used Topics
                </label>
                <div class="grid grid-cols-2 gap-2 mb-4" id="recentTopicsGrid">
                    ${recentTopics.map((item, index) => `
                        <button type="button" 
                                class="recent-topic-btn p-3 text-left bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-red-500 rounded-lg transition-all duration-200 group"
                                onclick="selectRecentTopic('${item.topic.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${item.difficulty}')"
                                title="Last used: ${item.lastUsed}">
                            <div class="text-sm font-medium text-gray-200 group-hover:text-white truncate">${item.topic}</div>
                            <div class="text-xs text-gray-400 mt-1">${item.difficulty} • ${item.lastUsed}</div>
                        </button>
                    `).join('')}
                </div>
            `;
            
            container.insertBefore(recentSection, topicInput.nextSibling);
        }

        // Phase 3: Select a recent topic
        function selectRecentTopic(topic, difficulty) {
            mathTopicInput.value = topic;
            difficultySelect.value = difficulty;
            mathTopicInput.focus();
            
            // Provide feedback
            displayMessage(`Selected: ${topic} (${difficulty})`, 'text-green-400');
        }

        // Phase 3: Topic Recommendation Engine
        class TopicRecommendationEngine {
            static getTopicRecommendations(currentTopic = '', limit = 4) {
                const stats = DataManager.loadStats();
                const history = DataManager.loadHistory();
                const preferences = DataManager.loadPreferences();
                
                // Base topic suggestions organized by category
                const topicDatabase = {
                    algebra: [
                        "Linear equations for Grade 9",
                        "Quadratic equations for Form 4", 
                        "Systems of equations for Grade 10",
                        "Polynomial operations for Form 5",
                        "Factoring techniques for Grade 9",
                        "Inequalities for Grade 10"
                    ],
                    geometry: [
                        "Circle theorems for Form 3",
                        "Triangle properties for Grade 8",
                        "Area and perimeter for Grade 7",
                        "3D shapes and volumes for Form 4",
                        "Coordinate geometry for Grade 10",
                        "Trigonometry basics for Form 4"
                    ],
                    calculus: [
                        "Limits and continuity for Form 6",
                        "Derivatives for A-Level",
                        "Integration for Form 6",
                        "Applications of calculus for Grade 12",
                        "Differential equations for A-Level"
                    ],
                    statistics: [
                        "Data analysis for Grade 9",
                        "Probability for Form 5",
                        "Normal distribution for A-Level",
                        "Hypothesis testing for Grade 12",
                        "Regression analysis for Form 6"
                    ],
                    advanced: [
                        "Complex numbers for Form 6",
                        "Vectors for Grade 12",
                        "Matrices for A-Level",
                        "Sequences and series for Form 5",
                        "Logarithms for Grade 11"
                    ]
                };
                
                let recommendations = [];
                
                // 1. Analyze current topic to suggest related topics
                if (currentTopic) {
                    const category = this.categorizeTopic(currentTopic);
                    if (category && topicDatabase[category]) {
                        recommendations.push(...topicDatabase[category]
                            .filter(topic => !topic.toLowerCase().includes(currentTopic.toLowerCase().split(' ')[0]))
                            .slice(0, 2));
                    }
                }
                
                // 2. Suggest topics based on user's favorite subjects
                const favoriteTopics = Object.entries(stats.favoriteTopics || {})
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([topic]) => topic);
                
                favoriteTopics.forEach(favTopic => {
                    const category = this.categorizeTopic(favTopic);
                    if (category && topicDatabase[category]) {
                        recommendations.push(...topicDatabase[category]
                            .filter(topic => !recommendations.includes(topic))
                            .slice(0, 1));
                    }
                });
                
                // 3. Progressive difficulty suggestions
                const userPreferredDifficulty = preferences.preferredDifficulty || 'Medium';
                const nextLevel = this.getNextDifficultyLevel(userPreferredDifficulty);
                
                // 4. Fill remaining slots with popular topics
                const popularTopics = [
                    "Linear equations for Grade 9",
                    "Quadratic functions for Form 4",
                    "Circle theorems for Form 3",
                    "Trigonometry basics for Grade 10",
                    "Probability for Form 5",
                    "Derivatives for Form 6"
                ].filter(topic => !recommendations.includes(topic));
                
                recommendations.push(...popularTopics);
                
                // Remove duplicates and limit results
                recommendations = [...new Set(recommendations)].slice(0, limit);
                
                return recommendations.map(topic => ({
                    topic,
                    difficulty: this.suggestDifficulty(topic, userPreferredDifficulty),
                    reason: this.getRecommendationReason(topic, currentTopic, favoriteTopics)
                }));
            }
            
            static categorizeTopic(topic) {
                const topicLower = topic.toLowerCase();
                if (topicLower.includes('algebra') || topicLower.includes('equation') || topicLower.includes('polynomial')) return 'algebra';
                if (topicLower.includes('geometry') || topicLower.includes('triangle') || topicLower.includes('circle') || topicLower.includes('area')) return 'geometry';
                if (topicLower.includes('calculus') || topicLower.includes('derivative') || topicLower.includes('integral') || topicLower.includes('limit')) return 'calculus';
                if (topicLower.includes('statistic') || topicLower.includes('probability') || topicLower.includes('data')) return 'statistics';
                if (topicLower.includes('complex') || topicLower.includes('vector') || topicLower.includes('matrix')) return 'advanced';
                return 'algebra'; // default category
            }
            
            static getNextDifficultyLevel(currentLevel) {
                const levels = ['Easy', 'Medium', 'Hard', 'Challenging'];
                const currentIndex = levels.indexOf(currentLevel);
                return currentIndex < levels.length - 1 ? levels[currentIndex + 1] : currentLevel;
            }
            
            static suggestDifficulty(topic, userPreferred) {
                // Suggest appropriate difficulty based on topic complexity
                if (topic.includes('Grade 7') || topic.includes('Grade 8')) return 'Easy';
                if (topic.includes('Form 6') || topic.includes('A-Level') || topic.includes('Grade 12')) return 'Hard';
                return userPreferred;
            }
            
            static getRecommendationReason(topic, currentTopic, favoriteTopics) {
                if (currentTopic && this.categorizeTopic(topic) === this.categorizeTopic(currentTopic)) {
                    return 'Related to current topic';
                }
                if (favoriteTopics.some(fav => this.categorizeTopic(topic) === this.categorizeTopic(fav))) {
                    return 'Based on your interests';
                }
                return 'Popular topic';
            }
        }

        // Phase 3: Add topic recommendations section
        function addTopicRecommendationsSection() {
            const currentTopic = document.getElementById('mathTopic')?.value.trim() || '';
            const recommendations = TopicRecommendationEngine.getTopicRecommendations(currentTopic, 4);
            
            if (recommendations.length === 0) return;
            
            const container = document.querySelector('.main-container');
            const recentSection = document.getElementById('recentTopicsSection') || document.getElementById('mathTopic')?.parentElement;
            
            if (!container || !recentSection) return;
            
            // Remove existing recommendations section
            const existingRecommendations = document.getElementById('recommendationsSection');
            if (existingRecommendations) {
                existingRecommendations.remove();
            }
            
            const recommendationsSection = document.createElement('div');
            recommendationsSection.id = 'recommendationsSection';
            recommendationsSection.className = 'mb-6';
            recommendationsSection.innerHTML = `
                <label class="block mb-3 text-sm font-medium text-gray-300">
                    💡 Recommended Topics for You
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    ${recommendations.map((item, index) => `
                        <button type="button" 
                                class="recommendation-btn p-3 text-left bg-gradient-to-r from-gray-800 to-gray-700 hover:from-red-900 hover:to-red-800 border border-gray-600 hover:border-red-500 rounded-lg transition-all duration-200 group"
                                onclick="selectRecommendedTopic('${item.topic.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${item.difficulty}')"
                                title="${item.reason}">
                            <div class="text-sm font-medium text-gray-200 group-hover:text-white mb-1">${item.topic}</div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs px-2 py-1 bg-red-600 text-white rounded">${item.difficulty}</span>
                                <span class="text-xs text-gray-400 group-hover:text-gray-300">${item.reason}</span>
                            </div>
                        </button>
                    `).join('')}
                </div>
            `;
            
            // Insert after recent topics section if it exists
            if (document.getElementById('recentTopicsSection')) {
                const recentTopicsSection = document.getElementById('recentTopicsSection');
                container.insertBefore(recommendationsSection, recentTopicsSection.nextSibling);
            } else {
                // Insert before the main topic input
                const topicInputDiv = document.getElementById('mathTopic')?.parentElement;
                if (topicInputDiv) {
                    container.insertBefore(recommendationsSection, topicInputDiv);
                }
            }
        }

        // Phase 3: Select a recommended topic
        function selectRecommendedTopic(topic, difficulty) {
            const mathTopicInput = document.getElementById('mathTopic');
            const difficultySelect = document.getElementById('difficulty');
            
            if (mathTopicInput) mathTopicInput.value = topic;
            if (difficultySelect) difficultySelect.value = difficulty;
            if (mathTopicInput) mathTopicInput.focus();
            
            // Provide feedback
            displayMessage(`Selected recommendation: ${topic} (${difficulty})`, 'text-blue-400');
            
            // Update recommendations based on new topic
            setTimeout(() => {
                addTopicRecommendationsSection();
            }, 500);
        }

        // Phase 3: Add stats dashboard
        function addStatsDashboard() {
            const container = document.querySelector('.main-container');
            const footer = document.querySelector('.footer');
            
            const statsSection = document.createElement('div');
            statsSection.className = 'mt-8 p-4 bg-gray-800 rounded-lg border border-gray-700';
            statsSection.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        📊 Your Progress
                    </h3>
                    <button type="button" 
                            class="text-xs text-gray-400 hover:text-gray-200 transition-colors"
                            onclick="toggleStatsDetails()"
                            id="statsToggleBtn">
                        Show Details
                    </button>
                </div>
                <div id="statsOverview" class="grid grid-cols-3 gap-4 text-center">
                    <div class="stats-item">
                        <div class="text-2xl font-bold text-red-400" id="totalQuestions">0</div>
                        <div class="text-xs text-gray-400">Questions Generated</div>
                    </div>
                    <div class="stats-item">
                        <div class="text-2xl font-bold text-red-400" id="totalSessions">0</div>
                        <div class="text-xs text-gray-400">Study Sessions</div>
                    </div>
                    <div class="stats-item">
                        <div class="text-2xl font-bold text-red-400" id="topicsExplored">0</div>
                        <div class="text-xs text-gray-400">Topics Explored</div>
                    </div>
                </div>
                <div id="statsDetails" class="mt-4 space-y-3 hidden">
                    <div id="favoriteTopicsSection"></div>
                    <div id="difficultyDistributionSection"></div>
                </div>
                
                <!-- Google Drive Status (optional) -->
                <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span>☁️ Google Drive:</span>
                            <span id="googleDriveStatus">Checking...</span>
                        </div>
                        <button id="googleDriveSetupBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded transition-colors hidden" onclick="showGoogleDriveSetup()">
                            Setup
                        </button>
                    </div>
                </div>
            `;
            
            container.insertBefore(statsSection, footer);
        }

        // Phase 3: Update stats display
        function updateStatsDisplay() {
            const stats = DataManager.loadStats();
            
            document.getElementById('totalQuestions').textContent = stats.totalQuestions;
            document.getElementById('totalSessions').textContent = stats.totalSessions;
            document.getElementById('topicsExplored').textContent = Object.keys(stats.favoriteTopics).length;
            
            // Update detailed stats if visible
            updateDetailedStats(stats);
        }

        // Phase 3: Update detailed stats
        function updateDetailedStats(stats) {
            const favoriteTopicsSection = document.getElementById('favoriteTopicsSection');
            const difficultyDistributionSection = document.getElementById('difficultyDistributionSection');
            
            if (!favoriteTopicsSection || !difficultyDistributionSection) return;
            
            // Favorite topics
            const topTopics = Object.entries(stats.favoriteTopics)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            favoriteTopicsSection.innerHTML = topTopics.length > 0 ? `
                <div class="text-sm font-medium text-gray-300 mb-2">Most Practiced Topics:</div>
                <div class="space-y-1">
                    ${topTopics.map(([topic, count]) => `
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-400 truncate">${topic}</span>
                            <span class="text-red-400">${count} times</span>
                        </div>
                    `).join('')}
                </div>
            ` : '<div class="text-xs text-gray-500">No topics practiced yet</div>';
            
            // Difficulty distribution
            const difficultyEntries = Object.entries(stats.difficultyDistribution);
            difficultyDistributionSection.innerHTML = difficultyEntries.length > 0 ? `
                <div class="text-sm font-medium text-gray-300 mb-2">Difficulty Breakdown:</div>
                <div class="grid grid-cols-2 gap-2">
                    ${difficultyEntries.map(([difficulty, count]) => `
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-400">${difficulty}:</span>
                            <span class="text-red-400">${count}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '<div class="text-xs text-gray-500">No difficulty data yet</div>';
        }

        // Phase 3: Toggle stats details
        function toggleStatsDetails() {
            const details = document.getElementById('statsDetails');
            const toggleBtn = document.getElementById('statsToggleBtn');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Details';
                updateDetailedStats(DataManager.loadStats());
            } else {
                details.classList.add('hidden');
                toggleBtn.textContent = 'Show Details';
            }
        }
        
        // Phase 3: Update recent topics display
        function updateRecentTopicsDisplay() {
            const recentTopicsGrid = document.getElementById('recentTopicsGrid');
            if (!recentTopicsGrid) return;
            
            const recentTopics = DataManager.getRecentTopics(6);
            
            if (recentTopics.length === 0) {
                recentTopicsGrid.parentElement.style.display = 'none';
                return;
            }
            
            recentTopicsGrid.innerHTML = recentTopics.map((item, index) => `
                <button type="button" 
                        class="recent-topic-btn p-3 text-left bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-red-500 rounded-lg transition-all duration-200 group"
                        onclick="selectRecentTopic('${item.topic.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${item.difficulty}')"
                        title="Last used: ${item.lastUsed}">
                    <div class="text-sm font-medium text-gray-200 group-hover:text-white truncate">${item.topic}</div>
                    <div class="text-xs text-gray-400 mt-1">${item.difficulty} • ${item.lastUsed}</div>
                </button>
            `).join('');
            
            recentTopicsGrid.parentElement.style.display = 'block';
        }
        
        // Phase 3: Add question to favorites
        function addToFavorites(problem, questionIndex, favoriteBtn) {
            const topic = mathTopicInput.value.trim();
            const difficulty = difficultySelect.value;
            
            DataManager.addToFavorites(
                problem.question,
                problem.correctAnswer,
                problem.stepByStepSolution,
                topic,
                difficulty
            );
            
            // Update button state
            favoriteBtn.textContent = '✓ Favorited';
            favoriteBtn.disabled = true;
            favoriteBtn.className = 'action-btn bg-green-600 hover:bg-green-700';
            
            // Show success message
            displayMessage(`Question ${questionIndex + 1} added to favorites!`, 'text-green-400');
        }

        // Phase 3: Show favorites panel
        function showFavoritesPanel() {
            const favorites = DataManager.loadFavorites();
            
            if (favorites.length === 0) {
                displayMessage('No favorite questions yet. Click the star button on any question to add it to favorites!', 'text-yellow-400');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            overlay.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto border border-red-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            ⭐ Your Favorite Questions (${favorites.length})
                        </h3>
                        <button class="action-btn bg-red-600 hover:bg-red-700" onclick="this.closest('.fixed').remove()">
                            Close
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${favorites.map((fav, index) => `
                            <div class="p-4 bg-gray-700 rounded-lg border border-gray-600">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="text-sm text-gray-400">${fav.topic} • ${fav.difficulty} • ${fav.date}</div>
                                    <button class="text-red-400 hover:text-red-300 text-sm" onclick="removeFavorite(${fav.id}, this)">
                                        Remove
                                    </button>
                                </div>
                                <div class="text-white mb-2">${fav.question}</div>
                                <div class="text-gray-300 text-sm">
                                    <strong>Answer:</strong> ${fav.answer}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on ESC or click outside
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            const closeOnEsc = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);
        }
        
        // Phase 3: Remove favorite
        function removeFavorite(favoriteId, buttonElement) {
            DataManager.removeFromFavorites(favoriteId);
            buttonElement.closest('.p-4').remove();
            displayMessage('Favorite removed!', 'text-orange-400');
        }
        
        // Mobile-specific features
        function initializeMobileFeatures() {
            // Add touch feedback to all buttons
            document.addEventListener('touchstart', function(e) {
                if (e.target.classList.contains('action-btn')) {
                    e.target.style.transform = 'scale(0.98)';
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('action-btn')) {
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 100);
                }
            });
            
            // Improve mobile keyboard experience
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    // Scroll into view on mobile to prevent keyboard overlap
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
            
            // Add pull-to-refresh hint (visual only)
            if (isMobileDevice()) {
                addPullToRefreshHint();
            }
        }
        
        // Detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Add subtle pull-to-refresh visual hint
        function addPullToRefreshHint() {
            const hint = document.createElement('div');
            hint.className = 'text-center text-gray-500 text-xs py-2';
            hint.textContent = '↓ Pull down to refresh ↓';
            hint.style.opacity = '0.5';
            
            const container = document.querySelector('.main-container');
            container.insertBefore(hint, container.firstChild);
            
            // Simple pull-to-refresh detection
            let startY = 0;
            let currentY = 0;
            let pullDistance = 0;
            
            container.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });
            
            container.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                pullDistance = currentY - startY;
                
                if (pullDistance > 0 && window.scrollY === 0) {
                    hint.style.opacity = Math.min(1, pullDistance / 100);
                    hint.style.transform = `translateY(${Math.min(pullDistance / 3, 20)}px)`;
                }
            });
            
            container.addEventListener('touchend', () => {
                if (pullDistance > 80 && window.scrollY === 0 && mathTopicInput.value.trim()) {
                    // Trigger refresh
                    if (!generateQuestionsBtn.disabled) {
                        generateMathQuestions();
                    }
                }
                
                // Reset hint
                hint.style.opacity = '0.5';
                hint.style.transform = 'translateY(0)';
                pullDistance = 0;
            });
        }

        // Network monitoring and fallback content
        function initializeNetworkMonitoring() {
            // Create network status indicator
            createNetworkStatusIndicator();
            
            // Monitor network status
            window.addEventListener('online', () => {
                isOnline = true;
                updateNetworkStatus();
                showNetworkMessage('🟢 Connection restored!', 'success');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateNetworkStatus();
                showNetworkMessage('🔴 No internet connection. Some features may be limited.', 'warning');
            });
            
            // Initial status update
            updateNetworkStatus();
        }
        
        function createNetworkStatusIndicator() {
            networkStatusIndicator = document.createElement('div');
            networkStatusIndicator.id = 'networkStatus';
            networkStatusIndicator.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300';
            networkStatusIndicator.style.display = 'none';
            document.body.appendChild(networkStatusIndicator);
        }
        
        function updateNetworkStatus() {
            if (!networkStatusIndicator) return;
            
            if (isOnline) {
                networkStatusIndicator.className = networkStatusIndicator.className.replace(/bg-\w+-\d+/, 'bg-green-600');
                networkStatusIndicator.textContent = '🟢 Online';
                networkStatusIndicator.style.display = 'none'; // Hide when online
            } else {
                networkStatusIndicator.className = networkStatusIndicator.className.replace(/bg-\w+-\d+/, 'bg-red-600');
                networkStatusIndicator.textContent = '🔴 Offline';
                networkStatusIndicator.style.display = 'block';
            }
        }
        
        function showNetworkMessage(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg text-white font-medium transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : 'bg-orange-600'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add fallback content for offline scenarios
        function getFallbackQuestions(topic, difficulty) {
            const fallbackQuestions = {
                easy: [
                    {
                        question: "Solve for x: $2x + 5 = 11$",
                        correctAnswer: "$x = 3$",
                        stepByStepSolution: "1. Subtract 5 from both sides: $2x = 6$\\n2. Divide both sides by 2: $x = 3$"
                    },
                    {
                        question: "What is $3 \\times 7$?",
                        correctAnswer: "$21$",
                        stepByStepSolution: "Simple multiplication: $3 \\times 7 = 21$"
                    },
                    {
                        question: "Find the area of a rectangle with length 5 cm and width 3 cm.",
                        correctAnswer: "$15 \\text{ cm}^2$",
                        stepByStepSolution: "Area = length × width = $5 \\times 3 = 15 \\text{ cm}^2$"
                    }
                ],
                medium: [
                    {
                        question: "Solve the quadratic equation: $x^2 - 5x + 6 = 0$",
                        correctAnswer: "$x = 2$ or $x = 3$",
                        stepByStepSolution: "1. Factor: $(x-2)(x-3) = 0$\\n2. Set each factor to zero: $x-2=0$ or $x-3=0$\\n3. Solve: $x = 2$ or $x = 3$"
                    },
                    {
                        question: "Find the derivative of $f(x) = 3x^2 + 2x - 1$",
                        correctAnswer: "$f'(x) = 6x + 2$",
                        stepByStepSolution: "Using power rule: $\\frac{d}{dx}[3x^2] = 6x$, $\\frac{d}{dx}[2x] = 2$, $\\frac{d}{dx}[-1] = 0$\\nTherefore: $f'(x) = 6x + 2$"
                    },
                    {
                        question: "Simplify: $\\frac{x^2 - 4}{x + 2}$ for $x \\neq -2$",
                        correctAnswer: "$x - 2$",
                        stepByStepSolution: "1. Factor numerator: $x^2 - 4 = (x+2)(x-2)$\\n2. Cancel common factor: $\\frac{(x+2)(x-2)}{x+2} = x-2$"
                    }
                ],
                hard: [
                    {
                        question: "Evaluate: $\\int_0^\\pi \\sin(x) \\, dx$",
                        correctAnswer: "$2$",
                        stepByStepSolution: "1. Find antiderivative: $\\int \\sin(x) \\, dx = -\\cos(x) + C$\\n2. Apply limits: $[-\\cos(x)]_0^\\pi = -\\cos(\\pi) - (-\\cos(0)) = -(-1) - (-1) = 2$"
                    },
                    {
                        question: "Find the limit: $\\lim_{x \\to 0} \\frac{\\sin(x)}{x}$",
                        correctAnswer: "$1$",
                        stepByStepSolution: "This is a standard limit. Using L'Hôpital's rule or the squeeze theorem:\\n$\\lim_{x \\to 0} \\frac{\\sin(x)}{x} = 1$"
                    },
                    {
                        question: "Solve the system: $\\begin{cases} 2x + 3y = 7 \\\\ 4x - y = 2 \\end{cases}$",
                        correctAnswer: "$x = 1, y = \\frac{5}{3}$",
                        stepByStepSolution: "1. From equation 2: $y = 4x - 2$\\n2. Substitute into equation 1: $2x + 3(4x - 2) = 7$\\n3. Simplify: $2x + 12x - 6 = 7$, so $14x = 13$, thus $x = \\frac{13}{14}$\\n4. Find y: $y = 4(\\frac{13}{14}) - 2 = \\frac{26}{14} - 2 = \\frac{26-28}{14} = -\\frac{1}{7}$"
                    }
                ]
            };
            
            const difficultyLevel = difficulty.toLowerCase();
            const questions = fallbackQuestions[difficultyLevel] || fallbackQuestions.medium;
            
            // Return a copy to avoid modifying the original
            return questions.map(q => ({ ...q }));
        }
        
        // Enhanced API call with offline fallback
        async function makeAPICallWithRetry(url, payload, retries = CONFIG.MAX_RETRIES) {
            // Check if offline first
            if (!isOnline) {
                throw new Error('No internet connection available');
            }
            
            let lastError;
            
            for (let i = 0; i < retries; i++) {
                try {
                    // Show retry attempt if not first try
                    if (i > 0) {
                        updateLoadingMessage(`Retrying... (Attempt ${i + 1}/${retries})`);
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || response.statusText;
                        throw new Error(`HTTP ${response.status}: ${errorMessage}`);
                    }

                    return await response.json();
                } catch (error) {
                    lastError = error;
                    console.error(`API call attempt ${i + 1} failed:`, error);
                    
                    if (i === retries - 1) {
                        throw error; // Last attempt failed
                    }
                    
                    // Progressive backoff: wait longer for each retry
                    const delay = CONFIG.RETRY_DELAY * Math.pow(2, i);
                    updateLoadingMessage(`Network issue detected. Retrying in ${delay/1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Smart input features: autocomplete and example topics
        function initializeSmartInput() {
            populateExampleTopics();
            setupAutocomplete();
            setupDifficultyDescriptions();
        }
        
        // Example topics data
        const exampleTopics = [
            "Linear equations for Grade 9",
            "Quadratic functions for Form 4", 
            "Trigonometry basics for Grade 10",
            "Calculus derivatives for Form 6",
            "Geometry proofs for Grade 8",
            "Statistics and probability for Form 5",
            "Algebraic expressions for Grade 7",
            "Circle theorems for Form 3",
            "Logarithms for Grade 11",
            "Complex numbers for Form 6",
            "Vectors for Grade 12",
            "Integration for A-Level"
        ];
        
        // Math topic suggestions for autocomplete
        const mathTopicSuggestions = [
            "Linear equations",
            "Quadratic equations", 
            "Exponential functions",
            "Logarithmic functions",
            "Trigonometric functions",
            "Polynomial functions",
            "Rational functions",
            "Systems of equations",
            "Inequalities",
            "Sequences and series",
            "Matrices",
            "Vectors",
            "Complex numbers",
            "Limits",
            "Derivatives",
            "Integration",
            "Differential equations",
            "Statistics",
            "Probability",
            "Combinatorics",
            "Number theory",
            "Geometry",
            "Circle theorems",
            "Triangle properties",
            "Coordinate geometry",
            "Transformations",
            "Similarity and congruence",
            "Area and volume",
            "Pythagoras theorem"
        ];
        
        function populateExampleTopics() {
            const grid = document.getElementById('exampleTopicsGrid');
            grid.innerHTML = '';
            
            exampleTopics.forEach(topic => {
                const topicButton = document.createElement('div');
                topicButton.className = 'example-topic';
                topicButton.textContent = topic;
                topicButton.addEventListener('click', () => {
                    mathTopicInput.value = topic;
                    mathTopicInput.focus();
                    // Hide autocomplete dropdown if visible
                    const dropdown = document.getElementById('autocompleteDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                });
                grid.appendChild(topicButton);
            });
        }
        
        function setupAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            let selectedIndex = -1;
            
            mathTopicInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                if (value.length < 2) {
                    hideAutocomplete();
                    return;
                }
                
                const matches = mathTopicSuggestions.filter(suggestion => 
                    suggestion.toLowerCase().includes(value)
                ).slice(0, 8); // Limit to 8 suggestions
                
                if (matches.length > 0) {
                    showAutocomplete(matches);
                } else {
                    hideAutocomplete();
                }
                selectedIndex = -1;
            });
            
            mathTopicInput.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    selectSuggestion(items[selectedIndex].textContent);
                } else if (e.key === 'Escape') {
                    hideAutocomplete();
                }
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAutocomplete();
                }
            });
            
            function showAutocomplete(suggestions) {
                dropdown.innerHTML = '';
                suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = suggestion;
                    item.addEventListener('click', () => selectSuggestion(suggestion));
                    dropdown.appendChild(item);
                });
                dropdown.style.display = 'block';
            }
            
            function hideAutocomplete() {
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }
            
            function updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }
            
            function selectSuggestion(suggestion) {
                const currentValue = mathTopicInput.value;
                const words = currentValue.split(' ');
                words[words.length - 1] = suggestion;
                mathTopicInput.value = words.join(' ') + ' ';
                hideAutocomplete();
                mathTopicInput.focus();
            }
        }
        
        function setupDifficultyDescriptions() {
            const difficultyDescriptions = {
                'Easy': 'Simple problems with basic concepts and clear solutions',
                'Medium': 'Moderate complexity with step-by-step explanations',
                'Hard': 'Advanced problems requiring deeper mathematical understanding',
                'Challenging': 'Complex multi-step problems for advanced learners'
            };
            
            const descriptionElement = document.getElementById('difficultyDescription');
            
            difficultySelect.addEventListener('change', (e) => {
                const selectedDifficulty = e.target.value;
                descriptionElement.textContent = difficultyDescriptions[selectedDifficulty] || 
                    difficultyDescriptions['Medium'];
            });
        }

        // Check if KaTeX is properly loaded
        function checkKaTeXLoaded() {
            if (typeof renderMathInElement === 'function' && typeof katex !== 'undefined') {
                isKaTeXLoaded = true;
                console.log('KaTeX loaded successfully');
            } else {
                isKaTeXLoaded = false;
                displayMessage('Warning: Math rendering library failed to load. Math expressions may not display correctly.', 'text-amber-400');
                console.error('KaTeX failed to load');
            }
        }

        // Event listeners
        generateQuestionsBtn.addEventListener('click', generateMathQuestions);
        resetBtn.addEventListener('click', resetGenerator);
        toggleMathViewBtn.addEventListener('click', toggleMathView);
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        exportQuestionsBtn.addEventListener('click', exportQuestions);
        
        // Question navigation event listeners
        document.getElementById('prevQuestionBtn').addEventListener('click', () => navigateQuestion(-1));
        document.getElementById('nextQuestionBtn').addEventListener('click', () => navigateQuestion(1));

        // Keyboard navigation support
        document.addEventListener('keydown', handleKeyboardNavigation);
        
        // Enter key support for API key input
        apiKeyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveApiKey();
            }
        });

        // Enter key support for topic input
        mathTopicInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                generateMathQuestions();
            }
        });

        function handleKeyboardNavigation(e) {
            // ESC key to close revealed answers and hide error dialogs
            if (e.key === 'Escape') {
                // Close revealed answers
                document.querySelectorAll('.answer-content').forEach(content => {
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                        const revealBtn = content.parentElement.querySelector('.action-btn:last-child');
                        if (revealBtn) {
                            revealBtn.textContent = 'Show Answer & Steps';
                            revealBtn.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                
                // Hide error messages
                if (messageContainer.innerHTML.includes('bg-red-900/20')) {
                    messageContainer.innerHTML = '';
                }
                
                // Close API key container if visible
                if (apiKeyContainer.style.display === 'block') {
                    apiKeyContainer.style.display = 'none';
                }
            }
            
            // F5 or Ctrl+R to generate new questions (if topic is filled)
            if ((e.key === 'F5' || (e.ctrlKey && e.key === 'r')) && mathTopicInput.value.trim()) {
                e.preventDefault();
                if (!generateQuestionsBtn.disabled) {
                    generateMathQuestions();
                }
            }
            
            // Ctrl+K to focus on topic input
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                mathTopicInput.focus();
                mathTopicInput.select();
            }
            
            // Ctrl+E to export questions (if available)
            if (e.ctrlKey && e.key === 'e' && currentQuestions.length > 0) {
                e.preventDefault();
                exportQuestions();
            }
            
            // Arrow keys for question navigation (if multiple questions)
            if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && totalQuestions > 1 && !questionsContainer.classList.contains('hidden')) {
                e.preventDefault();
                const direction = e.key === 'ArrowLeft' ? -1 : 1;
                navigateQuestion(direction);
            }
            
            // Number keys 1-3 to reveal specific answers (if questions are visible)
            if (['1', '2', '3'].includes(e.key) && questionsContainer.classList.contains('hidden') === false) {
                const questionIndex = parseInt(e.key) - 1;
                const questions = document.querySelectorAll('.question-item');
                if (questions[questionIndex]) {
                    const revealBtn = questions[questionIndex].querySelector('.action-btn:last-child');
                    if (revealBtn) {
                        revealBtn.click();
                    }
                }
            }
            
            // ? key to show keyboard shortcuts help
            if (e.key === '?' && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                showKeyboardShortcuts();
            }
            
            // Ctrl+F to show favorites
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                showFavoritesPanel();
            }
        }
        
        // Show keyboard shortcuts overlay
        function showKeyboardShortcuts() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-4 border border-red-500/30">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ⌨️ Keyboard Shortcuts
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-300">Generate Questions:</span><span class="text-red-400">Ctrl + Enter</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Focus Topic Input:</span><span class="text-red-400">Ctrl + K</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Export Questions:</span><span class="text-red-400">Ctrl + E</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Navigate Questions:</span><span class="text-red-400">← →</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Refresh/Regenerate:</span><span class="text-red-400">F5</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Show Answer 1-3:</span><span class="text-red-400">1, 2, 3</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Show Favorites:</span><span class="text-red-400">Ctrl + F</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Close Dialogs:</span><span class="text-red-400">Escape</span></div>
                        <div class="flex justify-between"><span class="text-gray-300">Show This Help:</span><span class="text-red-400">?</span></div>
                    </div>
                    <button class="mt-4 w-full action-btn bg-red-600 hover:bg-red-700" onclick="this.parentElement.parentElement.remove()">
                        Close (ESC)
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on ESC or click outside
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            const closeOnEsc = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);
        }

        // Export questions to text file
        function exportQuestions() {
            if (currentQuestions.length === 0) {
                displayMessage('No questions to export. Generate some questions first.', 'text-orange-400');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const topic = mathTopicInput.value.trim() || 'Math Questions';
            const difficulty = difficultySelect.value;
            
            let exportContent = `Math Questions Export\n`;
            exportContent += `Generated on: ${new Date().toLocaleString()}\n`;
            exportContent += `Topic: ${topic}\n`;
            exportContent += `Difficulty: ${difficulty}\n`;
            exportContent += `\n${'='.repeat(50)}\n\n`;

            currentQuestions.forEach((problem, index) => {
                exportContent += `Problem ${index + 1}:\n`;
                exportContent += `${problem.question}\n\n`;
                exportContent += `Answer:\n${problem.correctAnswer}\n\n`;
                exportContent += `Solution:\n${problem.stepByStepSolution.replace(/\\n/g, '\n')}\n\n`;
                exportContent += `${'-'.repeat(30)}\n\n`;
            });

            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sage-questions-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            displayMessage('Questions exported successfully!', 'text-green-400');
        }

        // Performance optimization: Debounced input validation
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced input validation
        function validateInput(topic) {
            if (!topic || topic.trim().length < 3) {
                return 'Please enter a maths topic with at least 3 characters.';
            }
            if (topic.length > 500) {
                return 'Maths topic is too long. Please keep it under 500 characters.';
            }
            
            // Check for potentially harmful content
            const suspiciousPatterns = [
                /<script/i,
                /javascript:/i,
                /on\w+\s*=/i,
                /data:text\/html/i
            ];
            
            if (suspiciousPatterns.some(pattern => pattern.test(topic))) {
                return 'Invalid characters detected in input. Please use only text and mathematical expressions.';
            }
            
            return null;
        }

        // Validate API key format
        function validateApiKey(apiKey) {
            if (!apiKey || apiKey.trim().length < 10) {
                return 'API key appears to be too short. Please check your Gemini API key.';
            }
            if (!/^[A-Za-z0-9_-]+$/.test(apiKey)) {
                return 'API key contains invalid characters. Please check your Gemini API key.';
            }
            return null;
        }

        // Sanitize HTML content
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Save API key with validation
        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            
            const validationError = validateApiKey(apiKey);
            if (validationError) {
                displayMessage(validationError, 'text-red-500');
                apiKeyInput.focus();
                return;
            }
            
            localStorage.setItem(CONFIG.STORAGE_KEY, apiKey);
            apiKeyContainer.style.display = 'none';
            displayMessage('API key saved successfully!', 'text-green-400');
        }

        // Minimal preprocessing - only clean up obvious LaTeX issues
        function preprocessMathContent(content) {
            if (!content) return content;
            
            // Only do minimal cleanup, preserve all spacing
            let processed = content;
            
            // Only clean up \text{} wrappers if they exist
            if (processed.includes('\\text{')) {
                processed = processed.replace(/\\text\{([^}]*)\}/g, '$1');
            }
            
            // Convert \n to proper line breaks but preserve all other spacing
            if (processed.includes('\\n')) {
                processed = processed.replace(/\\n/g, '\n');
            }
            
            // Only add delimiters if content has LaTeX commands but no delimiters
            if (!processed.includes('$') && processed.includes('\\')) {
                // Check if it's a pure math expression (starts with LaTeX command)
                if (/^\\(frac|sqrt|int|sum)/.test(processed.trim())) {
                    return `$$${processed}$$`;
                }
            }
            
            // Return content unchanged - let KaTeX handle it naturally
            return processed;
        }
        
        // Function to render math when content is added to the DOM
        function renderMathContent(element) {
            if (!isKaTeXLoaded) {
                console.warn('KaTeX not loaded, skipping math rendering');
                return;
            }

            const mathElements = element.querySelectorAll('.math-rendered');
            mathElements.forEach(mathEl => {
                const originalContent = mathEl.innerHTML;
                const cacheKey = originalContent;
                
                if (mathRenderCache.has(cacheKey)) {
                    mathEl.innerHTML = mathRenderCache.get(cacheKey);
                } else {
                    try {
                        // Only render if content has math delimiters or LaTeX commands
                        if (originalContent.includes('$') || originalContent.includes('\\frac') || originalContent.includes('\\int') || originalContent.includes('\\sum')) {
                            // Render with KaTeX - let it handle the content naturally
                            renderMathInElement(mathEl, {
                                delimiters: [
                                    {left: "$$", right: "$$", display: true},
                                    {left: "$", right: "$", display: false}
                                ],
                                throwOnError: false,
                                errorColor: '#ef4444',
                                strict: false,
                                trust: false
                            });
                            
                            mathRenderCache.set(cacheKey, mathEl.innerHTML);
                        }
                        // If no math indicators, leave content as-is (don't process regular text)
                    } catch (error) {
                        console.error('Error rendering math:', error);
                        // Keep original content on error
                        mathEl.innerHTML = originalContent;
                    }
                }
            });
        }

        // Retry math rendering with delay
        function retryMathRendering(element, maxRetries = 3, delay = 500) {
            let retries = 0;
            
            const attemptRender = () => {
                if (retries >= maxRetries) {
                    console.warn('Max retries reached for math rendering');
                    return;
                }
                
                retries++;
                
                if (isKaTeXLoaded) {
                    renderMathContent(element);
                } else {
                    console.log(`Math rendering retry ${retries}/${maxRetries} - KaTeX not ready`);
                    setTimeout(attemptRender, delay);
                }
            };
            
            attemptRender();
        }

        // Function to toggle between rendered math and raw LaTeX
        function toggleMathView() {
            isMathRendered = !isMathRendered;
            toggleMathViewBtn.textContent = isMathRendered ? 'Toggle Math View (Rendered)' : 'Toggle Math View (Raw LaTeX)';

            document.querySelectorAll('.math-rendered').forEach(renderedDiv => {
                renderedDiv.style.display = isMathRendered ? 'block' : 'none';
            });
            document.querySelectorAll('.latex-view').forEach(latexDiv => {
                latexDiv.style.display = isMathRendered ? 'none' : 'block';
            });
        }

        // Modern clipboard API with fallback
        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    displayMessage("Copied to clipboard!", "text-green-400");
                } else {
                    // Fallback for older browsers or non-secure contexts
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        displayMessage("Copied to clipboard!", "text-green-400");
                    } else {
                        throw new Error('Copy command failed');
                    }
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
                displayMessage("Failed to copy text. Please copy manually.", "text-red-500");
            }
            
            // Hide message after timeout
            setTimeout(() => { 
                if (messageContainer.innerHTML.includes('Copied to clipboard') || messageContainer.innerHTML.includes('Failed to copy')) {
                    messageContainer.innerHTML = ''; 
                }
            }, CONFIG.MESSAGE_TIMEOUT);
        }

        // Enhanced retry mechanism for API calls with better error handling
        async function makeAPICallWithRetry(url, payload, retries = CONFIG.MAX_RETRIES) {
            let lastError;
            
            for (let i = 0; i < retries; i++) {
                try {
                    // Show retry attempt if not first try
                    if (i > 0) {
                        updateLoadingMessage(`Retrying... (Attempt ${i + 1}/${retries})`);
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || response.statusText;
                        throw new Error(`HTTP ${response.status}: ${errorMessage}`);
                    }

                    return await response.json();
                } catch (error) {
                    lastError = error;
                    console.error(`API call attempt ${i + 1} failed:`, error);
                    
                    if (i === retries - 1) {
                        throw error; // Last attempt failed
                    }
                    
                    // Progressive backoff: wait longer for each retry
                    const delay = CONFIG.RETRY_DELAY * Math.pow(2, i);
                    updateLoadingMessage(`Network issue detected. Retrying in ${delay/1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Enhanced loading management with progress tracking
        let loadingProgress = 0;
        let loadingInterval;
        const loadingMessages = [
            "Analyzing your math topic...",
            "Consulting mathematical knowledge base...",
            "Crafting problems for your level...",
            "Adding solution steps...",
            "Formatting mathematical expressions...",
            "Almost ready!"
        ];

        function updateLoadingMessage(message) {
            const loadingMessageEl = document.getElementById('loadingMessage');
            if (loadingMessageEl) {
                loadingMessageEl.textContent = message;
            }
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
            }
        }

        function startLoadingAnimation() {
            loadingProgress = 0;
            updateProgress(0);
            updateLoadingMessage(loadingMessages[0]);
            
            // Simulate realistic progress
            loadingInterval = setInterval(() => {
                loadingProgress += Math.random() * 15 + 5; // 5-20% increments
                
                if (loadingProgress >= 100) {
                    loadingProgress = 100;
                    updateProgress(100);
                    updateLoadingMessage("Finalizing your questions...");
                    clearInterval(loadingInterval);
                } else {
                    updateProgress(loadingProgress);
                    const messageIndex = Math.min(
                        Math.floor(loadingProgress / 20), 
                        loadingMessages.length - 1
                    );
                    updateLoadingMessage(loadingMessages[messageIndex]);
                }
            }, 800 + Math.random() * 400); // 800-1200ms intervals
        }

        function stopLoadingAnimation() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
            loadingProgress = 0;
            updateProgress(0);
        }

        // Get user-friendly error message with actionable suggestions
        function getErrorMessage(error) {
            const errorStr = error.message.toLowerCase();
            
            if (errorStr.includes('401') || errorStr.includes('invalid api key')) {
                return {
                    message: "Your API key appears to be invalid or expired.",
                    suggestion: "Please check your Gemini API key and make sure it's correctly entered.",
                    action: "show_api_key"
                };
            } else if (errorStr.includes('403') || errorStr.includes('forbidden')) {
                return {
                    message: "Access denied. Your API key may not have the required permissions.",
                    suggestion: "Ensure your Gemini API key has access to the Generative Language API.",
                    action: "show_api_key"
                };
            } else if (errorStr.includes('429') || errorStr.includes('rate limit')) {
                return {
                    message: "Too many requests. You've hit the rate limit.",
                    suggestion: "Please wait a few minutes before trying again, or check your API quota.",
                    action: "retry_later"
                };
            } else if (errorStr.includes('quota') || errorStr.includes('billing')) {
                return {
                    message: "API quota exceeded or billing issue detected.",
                    suggestion: "Check your Google Cloud billing account and API quotas.",
                    action: "check_billing"
                };
            } else if (errorStr.includes('network') || errorStr.includes('fetch')) {
                return {
                    message: "Network connection issue detected.",
                    suggestion: "Check your internet connection and try again.",
                    action: "retry"
                };
            } else if (errorStr.includes('json') || errorStr.includes('parse')) {
                return {
                    message: "Received malformed response from the API.",
                    suggestion: "This might be a temporary issue. Try generating questions again.",
                    action: "retry"
                };
            } else {
                return {
                    message: "An unexpected error occurred while generating questions.",
                    suggestion: "Try again with a simpler topic or different difficulty level.",
                    action: "retry"
                };
            }
        }

        // Enhanced error display with retry button
        function displayEnhancedError(error) {
            const errorInfo = getErrorMessage(error);
            
            const errorContainer = document.createElement('div');
            errorContainer.className = 'bg-red-900/20 border border-red-500/30 rounded-lg p-4 mt-4';
            
            errorContainer.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-red-400 text-xl">⚠️</div>
                    <div class="flex-1">
                        <h4 class="text-red-400 font-semibold mb-2">${errorInfo.message}</h4>
                        <p class="text-gray-300 text-sm mb-3">${errorInfo.suggestion}</p>
                        <div class="flex gap-2 flex-wrap">
                            ${errorInfo.action === 'retry' ? '<button id="retryBtn" class="action-btn bg-red-600 hover:bg-red-700 text-sm">Try Again</button>' : ''}
                            ${errorInfo.action === 'show_api_key' ? '<button id="showApiKeyBtn" class="action-btn bg-blue-600 hover:bg-blue-700 text-sm">Update API Key</button>' : ''}
                            ${errorInfo.action === 'retry_later' ? '<button id="retryLaterBtn" class="action-btn bg-yellow-600 hover:bg-yellow-700 text-sm">Retry in 1 minute</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            messageContainer.innerHTML = '';
            messageContainer.appendChild(errorContainer);
            
            // Add event listeners for action buttons
            const retryBtn = errorContainer.querySelector('#retryBtn');
            const showApiKeyBtn = errorContainer.querySelector('#showApiKeyBtn');
            const retryLaterBtn = errorContainer.querySelector('#retryLaterBtn');
            
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    messageContainer.innerHTML = '';
                    generateMathQuestions();
                });
            }
            
            if (showApiKeyBtn) {
                showApiKeyBtn.addEventListener('click', () => {
                    apiKeyContainer.style.display = 'block';
                    apiKeyInput.focus();
                });
            }
            
            if (retryLaterBtn) {
                retryLaterBtn.addEventListener('click', () => {
                    retryLaterBtn.disabled = true;
                    retryLaterBtn.textContent = 'Waiting...';
                    setTimeout(() => {
                        messageContainer.innerHTML = '';
                        generateMathQuestions();
                    }, 60000); // 1 minute delay
                });
            }
        }

        async function generateMathQuestions() {
            const mathTopic = mathTopicInput.value.trim();
            const difficulty = difficultySelect.value;
            const apiKey = localStorage.getItem(CONFIG.STORAGE_KEY);

            // Validation
            if (!apiKey) {
                apiKeyContainer.style.display = 'block';
                displayMessage("Please enter your Gemini API key first.", "text-red-500");
                return;
            }

            const validationError = validateInput(mathTopic);
            if (validationError) {
                displayMessage(validationError, "text-red-500");
                return;
            }

            // Hide previous messages/questions, show loading
            initialMessage.classList.add('hidden');
            questionsContainer.classList.add('hidden');
            resetBtn.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateQuestionsBtn.disabled = true;
            mathQuestionsList.innerHTML = ''; // Clear previous questions
            messageContainer.innerHTML = ''; // Clear any previous error messages
            
            // Start enhanced loading animation
            startLoadingAnimation();

            // Construct the prompt for the Gemini API
            const prompt = `
                Generate 3 math problems for the following topic and grade level, with a difficulty level of "${difficulty}".
                For each problem, provide:
                - A "question" in LaTeX format (use $$ for display math, $ for inline math).
                - A "correctAnswer" in LaTeX format.
                - A "stepByStepSolution" in LaTeX format, explaining how to solve the problem.

                Math Topic & Grade Level: ${sanitizeHTML(mathTopic)}
                Difficulty: ${difficulty}

                Provide the output as a JSON array of objects. Each object in the array represents one problem.
                Example JSON structure:
                [
                  {
                    "question": "$$2x + 5 = 11$$ Solve for x.",
                    "correctAnswer": "$$x = 3$$",
                    "stepByStepSolution": "To solve $2x + 5 = 11$: \\n 1. Subtract 5 from both sides: $2x = 11 - 5 \\implies 2x = 6$. \\n 2. Divide by 2: $x = 6 / 2 \\implies x = 3$."
                  },
                  {
                    "question": "What is the area of a rectangle with length $l = 5$ cm and width $w = 3$ cm?",
                    "correctAnswer": "$$15 \\text{ cm}^2$$",
                    "stepByStepSolution": "The area of a rectangle is given by the formula $A = l \\times w$. \\n Given $l=5$ cm and $w=3$ cm, \\n $A = 5 \\times 3 = 15 \\text{ cm}^2$."
                  }
                ]
                Ensure the LaTeX is correctly escaped for JSON strings.
            `;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "correctAnswer": { "type": "STRING" },
                                    "stepByStepSolution": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "correctAnswer", "stepByStepSolution"]
                            }
                        }
                    }
                };

                const apiUrl = `${CONFIG.API_BASE_URL}?key=${apiKey}`;
                const result = await makeAPICallWithRetry(apiUrl, payload);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    try {
                        const mathProblems = JSON.parse(jsonText);
                        if (Array.isArray(mathProblems) && mathProblems.length > 0) {
                            displayMathQuestions(mathProblems);
                        } else {
                            throw new Error('Invalid response format');
                        }
                    } catch (parseError) {
                        console.error("Error parsing JSON response:", parseError);
                        displayMessage("Sorry, I received an invalid response format. Please try again.", "text-red-500");
                    }
                } else {
                    displayMessage("Sorry, I couldn't generate math problems. Please check your API key and try again.", "text-red-500");
                    console.error("Gemini API response structure unexpected:", result);
                }

            } catch (error) {
                console.error("Error generating math questions:", error);
                
                // Try fallback content if offline or network error
                if (!isOnline || error.message.includes('No internet connection') || error.message.includes('network') || error.message.includes('fetch')) {
                    updateLoadingMessage("Using offline fallback questions...");
                    setTimeout(() => {
                        const fallbackQuestions = getFallbackQuestions(mathTopic, difficulty);
                        displayMathQuestions(fallbackQuestions);
                        showNetworkMessage('📚 Showing sample questions (offline mode)', 'warning');
                    }, 1000);
                } else {
                    displayEnhancedError(error);
                    
                    // Show API key container for auth errors
                    if (error.message.includes('401') || error.message.includes('403')) {
                        apiKeyContainer.style.display = 'block';
                    }
                }
            } finally {
                stopLoadingAnimation();
                loadingIndicator.classList.add('hidden');
                generateQuestionsBtn.disabled = false;
            }
        }

        function displayMathQuestions(problems) {
            mathQuestionsList.innerHTML = ''; // Clear previous questions
            currentQuestions = problems; // Store for export functionality
            totalQuestions = problems.length;
            currentQuestionIndex = 0; // Reset to first question
            
            if (!Array.isArray(problems) || problems.length === 0) {
                displayMessage("No math problems were generated. Please try with a different topic.", "text-orange-400");
                return;
            }

            problems.forEach((problem, index) => {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'question-item';
                problemDiv.style.animationDelay = `${index * 0.1}s`; // Staggered animation
                problemDiv.setAttribute('role', 'listitem');

                const questionHeader = document.createElement('h3');
                questionHeader.className = 'text-xl font-semibold text-white mb-4';
                questionHeader.textContent = `Problem ${index + 1}:`;
                problemDiv.appendChild(questionHeader);

                // Container for rendered math
                const questionRenderedDiv = document.createElement('div');
                questionRenderedDiv.className = 'text-lg text-gray-200 mb-4 math-rendered';
                
                // Use innerHTML to preserve spacing and formatting
                if (problem.question.includes('\\') && !problem.question.includes('$')) {
                    // Only preprocess LaTeX content without delimiters
                    const processedQuestion = preprocessMathContent(problem.question);
                    questionRenderedDiv.innerHTML = sanitizeHTML(processedQuestion);
                } else {
                    // For regular text or already delimited math, preserve as-is
                    questionRenderedDiv.innerHTML = sanitizeHTML(problem.question);
                }
                problemDiv.appendChild(questionRenderedDiv);

                // Container for raw LaTeX
                const questionLatexDiv = document.createElement('div');
                questionLatexDiv.className = 'latex-view'; // Hidden by default initially
                questionLatexDiv.textContent = problem.question;
                problemDiv.appendChild(questionLatexDiv);

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-wrap gap-2 mt-4';

                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn bg-gray-600 hover:bg-gray-700';
                copyBtn.textContent = 'Copy Question';
                copyBtn.setAttribute('aria-label', `Copy question ${index + 1}`);
                copyBtn.addEventListener('click', () => copyToClipboard(problem.question));
                buttonContainer.appendChild(copyBtn);

                const revealBtn = document.createElement('button');
                revealBtn.className = 'action-btn bg-red-600 hover:bg-red-700';
                revealBtn.textContent = 'Show Answer & Steps';
                revealBtn.setAttribute('aria-label', `Show answer and steps for question ${index + 1}`);
                buttonContainer.appendChild(revealBtn);

                const similarBtn = document.createElement('button');
                similarBtn.className = 'action-btn bg-blue-600 hover:bg-blue-700';
                similarBtn.textContent = 'Generate Similar';
                similarBtn.setAttribute('aria-label', `Generate similar question to ${index + 1}`);
                similarBtn.addEventListener('click', () => generateSimilarQuestion(problem, index));
                buttonContainer.appendChild(similarBtn);
                
                // Phase 3: Add favorite button
                const favoriteBtn = document.createElement('button');
                favoriteBtn.className = 'action-btn bg-yellow-600 hover:bg-yellow-700';
                favoriteBtn.textContent = '⭐ Favorite';
                favoriteBtn.setAttribute('aria-label', `Add question ${index + 1} to favorites`);
                favoriteBtn.addEventListener('click', () => addToFavorites(problem, index, favoriteBtn));
                buttonContainer.appendChild(favoriteBtn);

                problemDiv.appendChild(buttonContainer);

                const answerContentDiv = document.createElement('div');
                answerContentDiv.className = 'answer-content text-gray-300';
                
                // Minimal processing - preserve content as much as possible
                let processedAnswer = problem.correctAnswer;
                let processedSolution = problem.stepByStepSolution;
                
                // Only preprocess if there's LaTeX without delimiters
                if (problem.correctAnswer.includes('\\') && !problem.correctAnswer.includes('$')) {
                    processedAnswer = preprocessMathContent(problem.correctAnswer);
                }
                
                if (problem.stepByStepSolution.includes('\\') && !problem.stepByStepSolution.includes('$')) {
                    processedSolution = preprocessMathContent(problem.stepByStepSolution);
                }
                
                // Convert \n to line breaks but preserve other formatting
                processedSolution = processedSolution.replace(/\\n/g, '<br>');
                
                answerContentDiv.innerHTML = `<div class="mb-3 p-2 bg-yellow-900/20 border border-yellow-600/30 rounded text-yellow-200 text-xs">
                                                 <span class="font-semibold">⚠️ AI Generated Content:</span> Please verify answers independently. AI responses may contain errors.
                                             </div>` +
                                             `<p class="font-bold text-red-400 mb-2">Correct Answer:</p><div class="mb-4 math-rendered">${sanitizeHTML(processedAnswer)}</div>` +
                                             `<div class="latex-view">${sanitizeHTML(problem.correctAnswer)}</div>` + // Raw LaTeX for answer
                                             `<p class="font-bold text-red-400 mb-2">Step-by-Step Solution:</p><div class="math-rendered">${sanitizeHTML(processedSolution)}</div>` +
                                             `<div class="latex-view">${sanitizeHTML(problem.stepByStepSolution.replace(/\\n/g, '<br>'))}</div>`; // Raw LaTeX for solution
                problemDiv.appendChild(answerContentDiv);

                revealBtn.addEventListener('click', () => {
                    const isVisible = answerContentDiv.style.display === 'block';
                    answerContentDiv.style.display = isVisible ? 'none' : 'block';
                    revealBtn.textContent = isVisible ? 'Show Answer & Steps' : 'Hide Answer & Steps';
                    revealBtn.setAttribute('aria-expanded', !isVisible);
                    
                    // Re-render math in the revealed section if it's currently rendered view
                    if (!isVisible && isMathRendered) {
                         retryMathRendering(answerContentDiv);
                    }
                });

                mathQuestionsList.appendChild(problemDiv);
            });

            questionsContainer.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            
            // Initialize question navigation
            if (totalQuestions > 1) {
                document.getElementById('questionNavigator').classList.remove('hidden');
                showQuestion(currentQuestionIndex);
                updateNavigationState();
            } else {
                // Show single question
                const questions = document.querySelectorAll('.question-item');
                if (questions.length > 0) {
                    questions[0].classList.add('active');
                }
            }
            
            // Phase 3: Save to history and update preferences
            const topic = mathTopicInput.value.trim();
            const difficulty = difficultySelect.value;
            
            // Update history and stats
            DataManager.addToHistory(topic, difficulty, problems.length);
            
            // Update user preferences
            const preferences = DataManager.loadPreferences();
            preferences.lastUsedTopic = topic;
            preferences.preferredDifficulty = difficulty;
            
            // Add to preferred topics if not already there
            const topicLower = topic.toLowerCase();
            if (!preferences.preferredTopics.some(t => t.toLowerCase() === topicLower)) {
                preferences.preferredTopics.unshift(topic);
                preferences.preferredTopics = preferences.preferredTopics.slice(0, 10); // Keep only top 10
            }
            
            DataManager.savePreferences(preferences);
            
            // Update UI components
            updateStatsDisplay();
            updateRecentTopicsDisplay();
            
            // Initial rendering of math after questions are added to DOM
            // Use retry mechanism to ensure KaTeX has time to initialize
            retryMathRendering(mathQuestionsList);
            
            // Ensure initial view state is applied based on isMathRendered
            document.querySelectorAll('.math-rendered').forEach(renderedDiv => {
                renderedDiv.style.display = isMathRendered ? 'block' : 'none';
            });
            document.querySelectorAll('.latex-view').forEach(latexDiv => {
                latexDiv.style.display = isMathRendered ? 'none' : 'block';
            });
        }

        // Question navigation functions
        function navigateQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < totalQuestions) {
                currentQuestionIndex = newIndex;
                showQuestion(currentQuestionIndex);
                updateNavigationState();
            }
        }
        
        function showQuestion(index) {
            const questions = document.querySelectorAll('.question-item');
            questions.forEach((question, i) => {
                question.classList.toggle('active', i === index);
            });
            
            // Update counter
            document.getElementById('questionCounter').textContent = 
                `Question ${index + 1} of ${totalQuestions}`;
        }
        
        function updateNavigationState() {
            const prevBtn = document.getElementById('prevQuestionBtn');
            const nextBtn = document.getElementById('nextQuestionBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === totalQuestions - 1;
        }

        // Generate similar question functionality
        async function generateSimilarQuestion(originalProblem, questionIndex) {
            const apiKey = localStorage.getItem(CONFIG.STORAGE_KEY);
            
            if (!apiKey) {
                showNetworkMessage('API key required for generating similar questions', 'warning');
                return;
            }
            
            if (!isOnline) {
                showNetworkMessage('Internet connection required for generating similar questions', 'warning');
                return;
            }
            
            // Show loading state for this specific question
            const similarBtn = document.querySelector(`[aria-label="Generate similar question to ${questionIndex + 1}"]`);
            const originalText = similarBtn.textContent;
            similarBtn.disabled = true;
            similarBtn.textContent = 'Generating...';
            
            try {
                const prompt = `
                    Generate 1 similar math problem to the following, keeping the same topic and difficulty level but with different numbers/context:
                    
                    Original Question: ${originalProblem.question}
                    
                    Generate a new problem that:
                    - Uses the same mathematical concepts
                    - Has similar difficulty level
                    - Uses different numbers or context
                    - Follows the same format with question, correctAnswer, and stepByStepSolution in LaTeX
                    
                    Provide the output as a JSON object:
                    {
                        "question": "...",
                        "correctAnswer": "...",
                        "stepByStepSolution": "..."
                    }
                `;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "correctAnswer": { "type": "STRING" },
                                "stepByStepSolution": { "type": "STRING" }
                            }
                        }
                    }
                };
                
                const apiUrl = `${CONFIG.API_BASE_URL}?key=${apiKey}`;
                const result = await makeAPICallWithRetry(apiUrl, payload, 2); // Fewer retries for similar questions
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const newProblem = JSON.parse(jsonText);
                    
                    // Replace the current question with the similar one
                    replaceProblemInList(questionIndex, newProblem);
                    showNetworkMessage('Similar question generated!', 'success');
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                console.error('Error generating similar question:', error);
                showNetworkMessage('Failed to generate similar question. Please try again.', 'warning');
            } finally {
                similarBtn.disabled = false;
                similarBtn.textContent = originalText;
            }
        }
        
        // Replace a specific problem in the displayed list
        function replaceProblemInList(index, newProblem) {
            // Update the stored questions array
            currentQuestions[index] = newProblem;
            
            // Find the question element
            const questions = document.querySelectorAll('.question-item');
            const questionElement = questions[index];
            
            if (questionElement) {
                // Update the question content
                const questionRendered = questionElement.querySelector('.math-rendered');
                const questionLatex = questionElement.querySelector('.latex-view');
                
                if (questionRendered) {
                    if (newProblem.question.includes('\\') && !newProblem.question.includes('$')) {
                        const processedQuestion = preprocessMathContent(newProblem.question);
                        questionRendered.innerHTML = sanitizeHTML(processedQuestion);
                    } else {
                        questionRendered.innerHTML = sanitizeHTML(newProblem.question);
                    }
                }
                if (questionLatex) questionLatex.textContent = newProblem.question;
                
                // Update answer content
                const answerContentDiv = questionElement.querySelector('.answer-content');
                if (answerContentDiv) {
                    let processedAnswer = newProblem.correctAnswer;
                    let processedSolution = newProblem.stepByStepSolution;
                    
                    // Only preprocess if there's LaTeX without delimiters
                    if (newProblem.correctAnswer.includes('\\') && !newProblem.correctAnswer.includes('$')) {
                        processedAnswer = preprocessMathContent(newProblem.correctAnswer);
                    }
                    
                    if (newProblem.stepByStepSolution.includes('\\') && !newProblem.stepByStepSolution.includes('$')) {
                        processedSolution = preprocessMathContent(newProblem.stepByStepSolution);
                    }
                    
                    // Convert \n to line breaks
                    processedSolution = processedSolution.replace(/\\n/g, '<br>');
                    
                    answerContentDiv.innerHTML = `<div class="mb-3 p-2 bg-yellow-900/20 border border-yellow-600/30 rounded text-yellow-200 text-xs">
                                                     <span class="font-semibold">⚠️ AI Generated Content:</span> Please verify answers independently. AI responses may contain errors.
                                                 </div>` +
                                                 `<p class="font-bold text-red-400 mb-2">Correct Answer:</p><div class="mb-4 math-rendered">${sanitizeHTML(processedAnswer)}</div>` +
                                                 `<div class="latex-view">${sanitizeHTML(newProblem.correctAnswer)}</div>` +
                                                 `<p class="font-bold text-red-400 mb-2">Step-by-Step Solution:</p><div class="math-rendered">${sanitizeHTML(processedSolution)}</div>` +
                                                 `<div class="latex-view">${sanitizeHTML(newProblem.stepByStepSolution.replace(/\\n/g, '<br>'))}</div>`;
                    
                    // Hide the answer initially
                    answerContentDiv.style.display = 'none';
                    const revealBtn = questionElement.querySelector('.action-btn:nth-child(2)'); // Second button (reveal)
                    if (revealBtn) {
                        revealBtn.textContent = 'Show Answer & Steps';
                        revealBtn.setAttribute('aria-expanded', 'false');
                    }
                }
                
                // Re-render math content
                retryMathRendering(questionElement);
                
                // Apply current view state
                const mathRenderedElements = questionElement.querySelectorAll('.math-rendered');
                const latexElements = questionElement.querySelectorAll('.latex-view');
                
                mathRenderedElements.forEach(el => {
                    el.style.display = isMathRendered ? 'block' : 'none';
                });
                latexElements.forEach(el => {
                    el.style.display = isMathRendered ? 'none' : 'block';
                });
            }
        }

        function resetGenerator() {
            mathTopicInput.value = ''; // Clear input
            difficultySelect.value = 'Medium'; // Reset difficulty
            mathQuestionsList.innerHTML = ''; // Clear questions
            currentQuestions = []; // Clear stored questions
            currentQuestionIndex = 0;
            totalQuestions = 0;
            document.getElementById('questionNavigator').classList.add('hidden'); // Hide navigator
            questionsContainer.classList.add('hidden');
            resetBtn.classList.add('hidden');
            initialMessage.classList.remove('hidden'); // Show initial message again
            messageContainer.innerHTML = ''; // Clear any messages
        }

        function displayMessage(message, colorClass) {
            const messageElement = document.createElement('p');
            messageElement.className = `text-center ${colorClass} font-medium py-4`;
            messageElement.textContent = message;
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
            
            initialMessage.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            
            if (colorClass.includes('red') || colorClass.includes('amber')) {
                questionsContainer.classList.add('hidden'); // Hide questions if error
                resetBtn.classList.add('hidden');
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Check KaTeX loading after a delay
        setTimeout(checkKaTeXLoaded, 1000);
    </script>
</body>
</html>
